apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.storeName }}
  labels:
    app: {{ .Values.storeName }}
    storeId: {{ .Values.storeId }}
    engine: woocommerce
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ .Values.storeName }}
  template:
    metadata:
      labels:
        app: {{ .Values.storeName }}
        storeId: {{ .Values.storeId }}
    spec:
      {{- if .Values.securityContext.enabled }}
      securityContext:
        runAsNonRoot: {{ .Values.securityContext.runAsNonRoot | default true }}
        runAsUser: {{ .Values.securityContext.runAsUser | default 33 }}
        fsGroup: {{ .Values.securityContext.fsGroup | default 33 }}
      {{- end }}
      initContainers:
      - name: wait-for-mysql
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for MySQL to be ready..."
          until nc -z {{ .Values.storeName }}-mysql 3306; do
            echo "MySQL is not ready yet, sleeping..."
            sleep 2
          done
          echo "MySQL is ready!"
      - name: wp-auto-install
        image: wordpress:cli-php8.2
        command:
        - sh
        - -c
        - |
          echo "=== Starting WordPress Auto-Installation ==="

          # Wait for WordPress files to be ready
          sleep 15

          # Check if WordPress is already installed
          if wp core is-installed --path=/var/www/html --allow-root 2>/dev/null; then
            echo "WordPress already installed, skipping..."
            exit 0
          fi

          echo "Installing WordPress..."
          wp core install \
            --path=/var/www/html \
            --url="{{ .Values.storeUrl }}" \
            --title="{{ .Values.storeName }}" \
            --admin_user=admin \
            --admin_password="{{ .Values.wordpress.adminPassword | default "Admin@123!" }}" \
            --admin_email="{{ .Values.wordpress.adminEmail | default "admin@example.com" }}" \
            --skip-email \
            --allow-root || echo "WordPress install failed or already installed"

          echo "Installing WooCommerce plugin..."
          wp plugin install woocommerce --activate --path=/var/www/html --allow-root || echo "WooCommerce install failed"

          echo "Configuring WooCommerce settings..."
          # Enable Cash on Delivery
          wp option update woocommerce_cod_settings '{"enabled":"yes","title":"Cash on Delivery","description":"Pay with cash upon delivery"}' --format=json --path=/var/www/html --allow-root || true

          # Set store currency
          wp option update woocommerce_currency 'INR' --path=/var/www/html --allow-root || true

          # Disable new product email notifications
          wp option update woocommerce_new_order_settings '{"enabled":"no"}' --format=json --path=/var/www/html --allow-root || true

          echo "Creating sample products..."
          # Create T-Shirt
          wp woocommerce product create \
            --name="Cotton T-Shirt" \
            --type=simple \
            --regular_price=500 \
            --description="Comfortable cotton t-shirt perfect for everyday wear" \
            --short_description="Premium quality cotton t-shirt" \
            --virtual=true \
            --manage_stock=true \
            --stock_quantity=100 \
            --status=publish \
            --path=/var/www/html \
            --user=admin \
            --allow-root || echo "T-Shirt creation failed"

          # Create Jeans
          wp woocommerce product create \
            --name="Denim Jeans" \
            --type=simple \
            --regular_price=1200 \
            --description="Classic blue denim jeans with comfortable fit" \
            --short_description="Stylish denim jeans" \
            --virtual=true \
            --manage_stock=true \
            --stock_quantity=50 \
            --status=publish \
            --path=/var/www/html \
            --user=admin \
            --allow-root || echo "Jeans creation failed"

          # Create Shoes
          wp woocommerce product create \
            --name="Casual Shoes" \
            --type=simple \
            --regular_price=1500 \
            --description="Comfortable casual shoes for daily wear" \
            --short_description="Trendy casual footwear" \
            --virtual=true \
            --manage_stock=true \
            --stock_quantity=30 \
            --status=publish \
            --path=/var/www/html \
            --user=admin \
            --allow-root || echo "Shoes creation failed"

          echo "Setting up WooCommerce pages..."
          wp woocommerce tool run install_pages --path=/var/www/html --user=admin --allow-root || true

          echo "=== WordPress and WooCommerce Auto-Installation Complete! ==="
          echo "Store URL: {{ .Values.storeUrl }}"
          echo "Admin Username: admin"
          echo "Admin Password: {{ .Values.wordpress.adminPassword | default "Admin@123!" }}"
        env:
        - name: WORDPRESS_DB_HOST
          value: "{{ .Values.storeName }}-mysql"
        - name: WORDPRESS_DB_USER
          value: {{ .Values.mysql.auth.username }}
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.mysql.auth.existingSecret | default (printf "%s-mysql-secret" .Values.storeName) }}
              key: mysql-password
        - name: WORDPRESS_DB_NAME
          value: {{ .Values.mysql.auth.database }}
        volumeMounts:
        - name: wordpress-data
          mountPath: /var/www/html
      containers:
      - name: wordpress
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        {{- if .Values.securityContext.enabled }}
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
              - ALL
            add:
              - NET_BIND_SERVICE
        {{- end }}
        ports:
        - containerPort: 80
          name: http
        env:
        - name: WORDPRESS_DB_HOST
          value: "{{ .Values.storeName }}-mysql"
        - name: WORDPRESS_DB_USER
          value: {{ .Values.mysql.auth.username }}
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.mysql.auth.existingSecret | default (printf "%s-mysql-secret" .Values.storeName) }}
              key: mysql-password
        - name: WORDPRESS_DB_NAME
          value: {{ .Values.mysql.auth.database }}
        livenessProbe:
          httpGet:
            path: /wp-admin/install.php
            port: http
          initialDelaySeconds: 120
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 6
        readinessProbe:
          httpGet:
            path: /wp-admin/install.php
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          limits:
            cpu: {{ .Values.resources.limits.cpu }}
            memory: {{ .Values.resources.limits.memory }}
          requests:
            cpu: {{ .Values.resources.requests.cpu }}
            memory: {{ .Values.resources.requests.memory }}
        volumeMounts:
        - name: wordpress-data
          mountPath: /var/www/html
      volumes:
      - name: wordpress-data
        persistentVolumeClaim:
          claimName: {{ .Values.storeName }}-wordpress-pvc
